@using AEMSWEB.Enums;

@{
    ViewData["Title"] = "Tariff";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@{
    bool canCreate = ViewBag.IsCreate ?? false;
    bool canEdit = ViewBag.IsEdit ?? false;
    bool canDelete = ViewBag.IsDelete ?? false;
    bool canRead = ViewBag.IsRead ?? false;
    int companyId = ViewBag.CompanyId;
}

<style>

    .modal-xxl {
        max-width: 95%;
    }

    .scrollable-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }

        .scrollable-tabs::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Edge */
        }

    .scroll-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        padding: 0.5rem;
        line-height: 1;
    }

    .scroll-left {
        left: 0;
    }

    .scroll-right {
        right: 0;
    }

    .nav-item {
        flex-shrink: 0; /* Prevent tab items from shrinking */
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <!-- Simple Header Section -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Tariff Management</h4>
                    <div>
                        <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addCopyTariffCustomer2CustomerModal">Copy Tariff Cust2Cust</button>
                        <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addCopyTariffCompany2CustomerModal">Copy Tariff Company2Cust</button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTariffModal">Add Tariff</button>
                    </div>
                </div>

                <!-- Simple Filter Section -->
                <div class="filter-section bg-light p-3 rounded mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label for="cmb_customer" class="form-label">Customer <span class="text-danger">*</span></label>
                            <select id="cmb_customer" style="width: 100%"></select>
                        </div>
                        <div class="col-md-3">
                            <label for="cmb_port" class="form-label">Port <span class="text-danger">*</span></label>
                            <select id="cmb_port" style="width: 100%"></select>
                        </div>

                        <div class="col-md-2 d-flex">
                            <button type="button" class="btn btn-primary btn-sm me-2" onclick="loadTariffGrid();">Search</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearSearch();">Clear</button>
                            <button class="btn btn-light btn-sm me-2" onclick="loadTariffGrid();">Refresh</button>
                        </div>
                    </div>
                </div>

                <!-- Scrollable Tabs Container -->
                <div class="position-relative py-2">
                    <!-- Scroll Buttons -->
                    <button class="btn btn-sm btn-secondary scroll-button scroll-left">
                        &lt;
                    </button>
                    <button class="btn btn-sm btn-secondary scroll-button scroll-right">
                        &gt;
                    </button>

                    <!-- Tab List -->
                    <div class="scrollable-tabs">
                        <ul class="nav nav-pills mb-3 flex-nowrap" id="serviceTabs" role="tablist">
                            <!-- Main Service Tabs -->
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#port-expenses" type="button" data-status="PortExpense">
                                    <span class="badge bg-secondary me-1">0</span> Port Expenses
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#launch-services" type="button" data-status="LaunchServices">
                                    <span class="badge bg-secondary me-1">0</span> Launch Services
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#equipments-used" type="button" data-status="EquipmentsUsed">
                                    <span class="badge bg-primary me-1">0</span> Equipments Used
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#crew-sign-on" type="button" data-status="CrewSignOn">
                                    <span class="badge bg-success me-1">0</span> Crew Sign On
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#crew-sign-off" type="button" data-status="CrewSignOff">
                                    <span class="badge bg-danger me-1">0</span> Crew Sign Off
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#crew-miscellaneous" type="button" data-status="CrewMiscellaneous">
                                    <span class="badge bg-info me-1">0</span> Crew Miscellaneous
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#medical-assistance" type="button" data-status="MedicalAssistance">
                                    <span class="badge bg-warning me-1">0</span> Medical Assistance
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#consignment-import" type="button" data-status="ConsignmentImport">
                                    <span class="badge bg-primary me-1">0</span> Consignment Import
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#consignment-export" type="button" data-status="ConsignmentExport">
                                    <span class="badge bg-success me-1">0</span> Consignment Export
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#third-party-supply" type="button" data-status="ThirdPartySupply">
                                    <span class="badge bg-danger me-1">0</span> Third Party Supply
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#fresh-water" type="button" data-status="FreshWaterSupply">
                                    <span class="badge bg-info me-1">0</span> Fresh Water
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#technicians-surveyors" type="button" data-status="TechniciansSurveyors">
                                    <span class="badge bg-warning me-1">0</span> Technicians Surveyors
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#landing-items" type="button" data-status="LandingItems">
                                    <span class="badge bg-primary me-1">0</span> Landing Items
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#other-service" type="button" data-status="OtherService">
                                    <span class="badge bg-success me-1">0</span> Other Service
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#agency-remuneration" type="button" data-status="AgencyRemuneration">
                                    <span class="badge bg-danger me-1">0</span> Agency Remuneration
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#visa" type="button" data-status="Visa">
                                    <span class="badge bg-danger me-1">0</span> Visa
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content" id="serviceTabContent">
                    <!-- Port Expenses Tab -->
                    <div class="tab-pane fade show active" id="port-expenses">
                        <!-- Grid for Port Expenses -->
                        <div id="grid-PortExpense" class="kendo-grid"></div>
                    </div>

                    <!-- Launch Services Tab -->
                    <div class="tab-pane fade" id="launch-services">

                        <!-- Grid for Launch Services -->
                        <div id="grid-LaunchServices" class="kendo-grid"></div>
                    </div>

                    <!-- Equipments Used Tab -->
                    <div class="tab-pane fade" id="equipments-used">

                        <!-- Grid for Equipments Used -->
                        <div id="grid-EquipmentsUsed" class="kendo-grid"></div>
                    </div>

                    <!-- Crew Sign On Tab -->
                    <div class="tab-pane fade" id="crew-sign-on">

                        <!-- Grid for Crew Sign On -->
                        <div id="grid-CrewSignOn" class="kendo-grid"></div>
                    </div>

                    <!-- Crew Sign Off Tab -->
                    <div class="tab-pane fade" id="crew-sign-off">

                        <!-- Grid for Crew Sign Off -->
                        <div id="grid-CrewSignOff" class="kendo-grid"></div>
                    </div>

                    <!-- Crew Miscellaneous Tab -->
                    <div class="tab-pane fade" id="crew-miscellaneous">

                        <!-- Grid for Crew Miscellaneous -->
                        <div id="grid-CrewMiscellaneous" class="kendo-grid"></div>
                    </div>

                    <!-- Medical Assistance Tab -->
                    <div class="tab-pane fade" id="medical-assistance">

                        <!-- Grid for Medical Assistance -->
                        <div id="grid-MedicalAssistance" class="kendo-grid"></div>
                    </div>

                    <!-- Consignment Import Tab -->
                    <div class="tab-pane fade" id="consignment-import">

                        <!-- Grid for Consignment Import -->
                        <div id="grid-ConsignmentImport" class="kendo-grid"></div>
                    </div>

                    <!-- Consignment Export Tab -->
                    <div class="tab-pane fade" id="consignment-export">

                        <!-- Grid for Consignment Export -->
                        <div id="grid-ConsignmentExport" class="kendo-grid"></div>
                    </div>

                    <!-- Third Party Supply Tab -->
                    <div class="tab-pane fade" id="third-party-supply">

                        <!-- Grid for Third Party Supply -->
                        <div id="grid-ThirdPartySupply" class="kendo-grid"></div>
                    </div>

                    <!-- Fresh Water Tab -->
                    <div class="tab-pane fade" id="fresh-water">

                        <!-- Grid for Fresh Water -->
                        <div id="grid-FreshWaterSupply" class="kendo-grid"></div>
                    </div>

                    <!-- Technicians Surveyors Tab -->
                    <div class="tab-pane fade" id="technicians-surveyors">

                        <!-- Grid for Technicians Surveyors -->
                        <div id="grid-TechniciansSurveyors" class="kendo-grid"></div>
                    </div>

                    <!-- Landing Items Tab -->
                    <div class="tab-pane fade" id="landing-items">

                        <!-- Grid for Landing Items -->
                        <div id="grid-LandingItems" class="kendo-grid"></div>
                    </div>

                    <!-- Other Service Tab -->
                    <div class="tab-pane fade" id="other-service">

                        <!-- Grid for Other Service -->
                        <div id="grid-OtherService" class="kendo-grid"></div>
                    </div>

                    <!-- Agency Remuneration Tab -->
                    <div class="tab-pane fade" id="agency-remuneration">

                        <!-- Grid for Agency Remuneration -->
                        <div id="grid-AgencyRemuneration" class="kendo-grid"></div>
                    </div>

                    <!-- Visa Tab -->
                    <div class="tab-pane fade" id="visa">

                        <!-- Grid for Visa -->
                        <div id="grid-Visa" class="kendo-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section externalhtml {
    @await Html.PartialAsync("_Tariff");
    @await Html.PartialAsync("_VisaTariff");
}

@section Scripts {
    <script>

        //================== GLOBAL VARIABLES ================== //
        let companyId = 0;
        let permissions = {};

        $(document).ready(function () {

            companyId = getUrlParameter('companyId') || 1;

            permissions = {
                canCreate: @Json.Serialize(canCreate),
                canEdit: @Json.Serialize(canEdit),
                canDelete: @Json.Serialize(canDelete),
                canRead: @Json.Serialize(canRead),
            };
            Refresh();
            loadTariffGrid();

        });

        function Refresh() {
            const portUrl = '@Url.Action("GetPortLookup", "Lookup", new { area = "" })?companyId=' + companyId;
            BindComboBox(portUrl, "cmb_port", "portName", "portId");

            const customerUrl = '@Url.Action("GetCustomerLookup", "Lookup", new { area = "" })?companyId=' + companyId;
            const columnsProperties = [
                { field: 'customerCode', title: 'Code', width: 100 },
                { field: 'customerName', title: 'Name', width: 200 }
            ];
            const filterFields = ['customerCode', 'customerName'];
            BindMultiColumnComboBox(customerUrl, "cmb_customer", "customerName", "customerId", columnsProperties, filterFields);

            const taskUrl = '@Url.Action("GetTaskLookup", "Lookup", new { area = "" })?companyId=' + companyId;
            BindComboBox(taskUrl, "tariff_cmb_task", "taskName", "taskId");

            const uomUrl = '@Url.Action("GetUomLookup", "Lookup", new { area = "" })?companyId=' + companyId;
            BindComboBox(uomUrl, "tariff_cmb_uom", "uomName", "uomId");

            var CalculateType = @((int)OrderTypeCategory.CalculateType);
            var BerthType = @((int)OrderTypeCategory.BerthType);

            const typeUrl = `@Url.Action("GetOrderTypeLookup", "Lookup", new { area = "" })?companyId=${companyId}&categoryId=${CalculateType}`;
            BindComboBox(typeUrl, "tariff_cmb_type", "orderTypeName", "orderTypeId");

            const fromplaceUrl = `@Url.Action("GetOrderTypeLookup", "Lookup", new { area = "" })?companyId=${companyId}&categoryId=${BerthType}`;
            BindComboBox(fromplaceUrl, "tariff_cmb_fromplace", "orderTypeName", "orderTypeId");
            BindComboBox(fromplaceUrl, "tariff_cmb_toplace", "orderTypeName", "orderTypeId");

        }

        function SelectedDropdown(DrpdwnName) {
        }

        function OnSelectDropdown(dataItem, DrpdwnName) {
            if (DrpdwnName === "tariff_cmb_task") {
                let selectedTaskId = dataItem.taskId;

                if (selectedTaskId) {
                    loadChargesDropdown(selectedTaskId);
                }
            }
        }

        function loadChargesDropdown(taskId) {
            const chargesUrl = `@Url.Action("GetChargeLookup", "Lookup", new { area = "" })?companyId=${companyId}&taskId=${taskId}`
            BindComboBox(chargesUrl, "tariff_cmb_chagre", "chargeName", "chargeId");
        }

        function getComboBoxValue(selector, defaultValue = 0) {
            let comboBox = $(selector).data('kendoComboBox') || $(selector).data('kendoMultiColumnComboBox');
            if (comboBox) {
                return parseInt(comboBox.value() || defaultValue, 10);
            } else {
                console.error(`ComboBox with selector '${selector}' is not initialized.`);
                alert(`ComboBox with selector '${selector}' is not loaded correctly. Please refresh the page or contact support.`);
                return defaultValue;
            }
        }

        function loadTariffGrid() {

            let customerId = getComboBoxValue('#cmb_customer', 0);
            let portId = getComboBoxValue('#cmb_port', 0);

            if (customerId == 0 || portId == 0) {
                 alert("Please select both the customer and the port.");
            } else {
                initializePortExpenseGrid();
                initializeLaunchServicesGrid();
                initializeEquipmentsUsedGrid();
                initializeCrewSignOnGrid();
                initializeCrewSignOffGrid();
                initializeCrewMiscellaneousGrid();
                initializeMedicalAssistanceGrid();
                initializeConsignmentImportGrid();
                initializeConsignmentExportGrid();
                initializeThirdPartySupplyGrid();
                initializeFreshWaterSupplyGrid();
                initializeTechniciansSurveyorsGrid();
                initializeLandingItemsGrid();
                initializeOtherServiceGrid();
                initializeAgencyRemunerationGrid();
                loadStatusCounts();
            }
        }

        function loadStatusCounts() {

            let customerId = getComboBoxValue('#cmb_customer', 0);
            let portId = getComboBoxValue('#cmb_port', 0);

            $.ajax({
                url: '@Url.Action("GetTariffStatusCounts", "Tariff", new { area = "Project" })',
                type: 'POST', // Use POST method
                data: {
                    searchString: '',
                    companyId: companyId,
                    customerId: customerId,
                    portId: portId
                },
                success: function (counts) {

                    $('#serviceTabs [data-status="PortExpense"] .badge').text(counts.portExpense);
                    $('#serviceTabs [data-status="LaunchServices"] .badge').text(counts.launchServices);
                    $('#serviceTabs [data-status="EquipmentsUsed"] .badge').text(counts.equipmentsUsed);
                    $('#serviceTabs [data-status="CrewSignOn"] .badge').text(counts.crewSignOn);
                    $('#serviceTabs [data-status="CrewSignOff"] .badge').text(counts.crewSignOff);
                    $('#serviceTabs [data-status="CrewMiscellaneous"] .badge').text(counts.crewMiscellaneous);
                    $('#serviceTabs [data-status="MedicalAssistance"] .badge').text(counts.medicalAssistance);
                    $('#serviceTabs [data-status="ConsignmentImport"] .badge').text(counts.consignmentImport);
                    $('#serviceTabs [data-status="ConsignmentExport"] .badge').text(counts.consignmentExport);
                    $('#serviceTabs [data-status="ThirdPartySupply"] .badge').text(counts.thirdPartySupply);
                    $('#serviceTabs [data-status="FreshWaterSupply"] .badge').text(counts.freshWaterSupply);
                    $('#serviceTabs [data-status="TechniciansSurveyors"] .badge').text(counts.techniciansSurveyors);
                    $('#serviceTabs [data-status="LandingItems"] .badge').text(counts.landingItems);
                    $('#serviceTabs [data-status="OtherService"] .badge').text(counts.otherService);
                    $('#serviceTabs [data-status="AgencyRemuneration"] .badge').text(counts.agencyRemuneration);
                    $('#serviceTabs [data-status="Visa"] .badge').text(counts.visa);
                },
                error: function (xhr, status, error) {
                    console.error('Error loading status counts:', error);
                }
            });
        }

        function clearSearch() {
            $('#cmb_customer').data('kendoMultiColumnComboBox').value('');
            $('#cmb_port').data('kendoComboBox').value('');
            initializePortExpenseGrid();
            initializeLaunchServicesGrid();
            initializeEquipmentsUsedGrid();
            initializeCrewSignOnGrid();
            initializeCrewSignOffGrid();
            initializeCrewMiscellaneousGrid();
            initializeMedicalAssistanceGrid();
            initializeConsignmentImportGrid();
            initializeConsignmentExportGrid();
            initializeThirdPartySupplyGrid();
            initializeFreshWaterSupplyGrid();
            initializeTechniciansSurveyorsGrid();
            initializeLandingItemsGrid();
            initializeOtherServiceGrid();
            initializeAgencyRemunerationGrid();
            loadStatusCounts();
        }

        //================== SCROLLABLE TABS ================== //
        document.querySelectorAll('.scroll-button').forEach(button => {
            button.addEventListener('click', function (e) {
                const container = document.querySelector('.scrollable-tabs');
                const scrollAmount = 200; // Adjust scroll amount
                container.scrollLeft += this.classList.contains('scroll-left') ? -scrollAmount : scrollAmount;
            });
        });

        const container = document.querySelector('.scrollable-tabs');
        const checkScroll = () => {
            document.querySelector('.scroll-left').style.display = container.scrollLeft <= 0 ? 'none' : 'block';
            document.querySelector('.scroll-right').style.display =
                container.scrollLeft + container.offsetWidth >= container.scrollWidth ? 'none' : 'block';
        };

        container.addEventListener('scroll', checkScroll);
        checkScroll();

        //================== GRID FUNCTIONS ================== //

        function initializePortExpenseGrid() {
            initializeTaskGrid("PortExpenses",   "@Url.Action("GetTariffPortExpensesList", "Tariff", new { area = "Project" })","grid-PortExpense");
        }

        function initializeLaunchServicesGrid() {
            initializeTaskGrid("LaunchServices","@Url.Action("GetTariffLaunchServicesList", "Tariff", new { area = "Project" })",  "grid-LaunchServices");
        }

        function initializeEquipmentsUsedGrid() {
            initializeTaskGrid("EquipmentsUsed","@Url.Action("GetTariffEquipmentsUsedList", "Tariff", new { area = "Project" })",  "grid-EquipmentsUsed");
        }

        function initializeCrewSignOnGrid() {
            initializeTaskGrid("CrewSignOn","@Url.Action("GetTariffCrewSignOnList", "Tariff", new { area = "Project" })",  "grid-CrewSignOn");
        }

        function initializeCrewSignOffGrid() {
            initializeTaskGrid("CrewSignOff", "@Url.Action("GetTariffCrewSignOffList", "Tariff", new { area = "Project" })", "grid-CrewSignOff");
        }

        function initializeCrewMiscellaneousGrid() {
            initializeTaskGrid("CrewMiscellaneous", "@Url.Action("GetTariffCrewMiscellaneousList", "Tariff", new { area = "Project" })", "grid-CrewMiscellaneous");
        }

        function initializeMedicalAssistanceGrid() {
            initializeTaskGrid("MedicalAssistance", "@Url.Action("GetTariffMedicalAssistanceList", "Tariff", new { area = "Project" })", "grid-MedicalAssistance");
        }

        function initializeConsignmentImportGrid() {
            initializeTaskGrid("ConsignmentImport", "@Url.Action("GetTariffConsignmentImportList", "Tariff", new { area = "Project" })", "grid-ConsignmentImport");
        }

        function initializeConsignmentExportGrid() {
            initializeTaskGrid("ConsignmentExport", "@Url.Action("GetTariffConsignmentExportList", "Tariff", new { area = "Project" })", "grid-ConsignmentExport");
        }

        function initializeThirdPartySupplyGrid() {
            initializeTaskGrid("ThirdPartySupply", "@Url.Action("GetTariffThirdPartySupplyList", "Tariff", new { area = "Project" })","grid-ThirdPartySupply");
        }

        function initializeFreshWaterSupplyGrid() {
            initializeTaskGrid("FreshWaterSupply", "@Url.Action("GetTariffFreshWaterSupplyList", "Tariff", new { area = "Project" })", "grid-FreshWaterSupply");
        }

        function initializeTechniciansSurveyorsGrid() {
            initializeTaskGrid("TechniciansSurveyors", "@Url.Action("GetTariffTechniciansSurveyorsList", "Tariff", new { area = "Project" })", "grid-TechniciansSurveyors");
        }

        function initializeLandingItemsGrid() {
            initializeTaskGrid("LandingItems", "@Url.Action("GetTariffLandingItemsList", "Tariff", new { area = "Project" })", "grid-LandingItems");
        }

        function initializeOtherServiceGrid() {
            initializeTaskGrid("OtherService", "@Url.Action("GetTariffOtherServiceList", "Tariff", new { area = "Project" })", "grid-OtherService");
        }

        function initializeAgencyRemunerationGrid() {
            initializeTaskGrid("AgencyRemuneration", "@Url.Action("GetTariffAgencyRemunerationList", "Tariff", new { area = "Project" })", "grid-AgencyRemuneration");
        }

        // ================== COMMON GRID ================== //

        function initializeTaskGrid(taskName, url, gridId) {

            let searchString = "";
            //let customerId = 1;
            //let portId = 3751;
            let customerId = getComboBoxValue('#cmb_customer', 0);
            let portId = getComboBoxValue('#cmb_port', 0);

            let columns = [
                {
                    title: "Actions",
                    width: "100px",
                    template: function (dataItem) {
                        let buttons = ` <button class="ps-0 border-0 bg-transparent" onclick="openTariffModal('${dataItem.tariffId}','${dataItem.taskId}','${dataItem.customerId}','${dataItem.portId}','${dataItem.chargeId}', 'view')">
            <i class="material-symbols-outlined text-primary">visibility</i></button>`;

                        if (permissions.canEdit) {
                            buttons += `<button class="ps-0 border-0 bg-transparent" onclick="openTariffModal('${dataItem.tariffId}','${dataItem.taskId}','${dataItem.customerId}','${dataItem.portId}','${dataItem.chargeId}',  'edit')">
            <i class="material-symbols-outlined text-warning">edit</i></button>`;
                        }

                        if (permissions.canDelete) {
                            buttons += `<button class="ps-0 border-0 bg-transparent" onclick="deleteTariff('${dataItem.tariffId}','${dataItem.taskId}','${dataItem.customerId}','${dataItem.portId}','${dataItem.chargeId}')">
            <i class="material-symbols-outlined text-danger">delete</i></button>`;
                        }
                        return buttons;
                    }
                },
                { field: "taskName", title: "task", width: "100px" },
                { field: "chargeName", title: "charges", width: "200px" },
                { field: "uomName", title: "Uom", width: "80px" },
                { field: "slabUomName", title: "Type", width: "80px" },
                { field: "fromPlaceName", title: "from Place", width: "80px" },
                { field: "toPlaceName", title: "to Plcae", width: "80px" },
                {
                    field: "displayRate",
                    title: "Display Rate",
                    width: "100px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "basicRate",
                    title: "Basic Rate",
                    width: "100px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "minUnit",
                    title: "Min Unit",
                    width: "100px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "maxUnit",
                    title: "Max Unit",
                    width: "100px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "isAdditional",
                    title: "Is Additional",
                    width: "120px",
                    template: "<input type='checkbox' #= isAdditional ? 'checked' : '' # disabled />" // Checkbox for boolean value
                },
                {
                    field: "additionalUnit",
                    title: "Additional Unit",
                    width: "130px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "additionalRate",
                    title: "Additional Rate",
                    width: "130px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "isPrepayment",
                    title: "Is Prepayment",
                    width: "120px",
                    template: "<input type='checkbox' #= isPrepayment ? 'checked' : '' # disabled />" // Checkbox for boolean value
                },
                {
                    field: "prepaymentPercentage",
                    title: "Pre.Pay.Percentage",
                    width: "140px",
                    format: "{0:n2}" // Format to display 2 decimal places
                },
                {
                    field: "isActive",
                    title: "Is Active",
                    width: "120px",
                    template: "<input type='checkbox' #= isActive ? 'checked' : '' # disabled />" // Checkbox for boolean value
                },
                { field: "remarks", title: "Remarks", width: "200px" }
            ];

            let grid = $(`#${gridId}`).data("kendoGrid");
            if (grid) {
                grid.dataSource.read({ searchString: searchString, companyId: companyId, customerId: customerId, portId: portId });
            } else {
                initializeKendoGrid(gridId, url, { searchString, companyId, customerId, portId }, columns);
            }
        }

        function openTariffModal(tariffId, taskId, customerId, portId, chargeId, mode) {
            const $modal = $('#addTariffModal');
            $modal.find('.modal-content').append('<div class="modal-overlay"><div class="spinner"></div></div>');
            $.get('@Url.Action("GetTariffById", "Tariff", new { area = "Project" })', {
                tariffId: tariffId,
                companyId: companyId,
                taskId: taskId,
                customerId: customerId,
                portId: portId,
                chargeId: chargeId
            })
                .done(function (response) {
                    if (response.success) {
                        populateTariffModalFields(response.data);
                        setTariffMode(mode);
                        $('#addTariffModal').modal('show');
                    } else {
                        alert(response.message || "Failed to load tariff data.");
                    }
                })
                .always(() => $modal.find('.modal-overlay').remove());
        }

        function populateTariffModalFields(data) {
            try {
                debugger;
                // Numeric Inputs
                $('#tariffId').val(data.tariffId || 0.000);
                // Tariff Fields
                $('#tariff_cmb_task').data("kendoComboBox").value(data.taskId > 0 ? data.taskId : '');
                loadChargesDropdown(data.taskId);
                $('#tariff_cmb_chagre').data("kendoComboBox").value(data.chargeId > 0 ? data.chargeId : '');
                $('#tariff_cmb_uom').data("kendoComboBox").value(data.uomId > 0 ? data.uomId : '');
                $('#tariff_cmb_type').data("kendoComboBox").value(data.tariffTypeId > 0 ? data.tariffTypeId : '');
                $('#tariff_cmb_fromplace').data("kendoComboBox").value(data.fromPlaceId > 0 ? data.fromPlaceId : '');
                $('#tariff_cmb_toplace').data("kendoComboBox").value(data.toPlaceId > 0 ? data.toPlaceId : '');
                $('#displayrate').val(data.displayRate || 0.000);
                $('#basicrate').val(data.basicRate || 0.000);
                $('#minunit').val(data.minUnit || 0.000);
                $('#maxunit').val(data.maxUnit || 0.000);
                $('#additionalunit').val(data.additionalUnit || 0.000);
                $('#additionalrate').val(data.additionalRate || 0.000);
                $('#prepaymentpercentage').val(data.prepaymentpercentage || 0.000);

                // Checkbox fields
                $('#isAdditional').prop('checked', data.isAdditional || false);
                $('#isprepayment').prop('checked', data.isPrepayment || false);

                // Enable/Disable Additional Fields
                $('#additionalunit').prop('readonly', !data.isAdditional);
                $('#additionalrate').prop('readonly', !data.isAdditional);

                // Set Audit Fields
                $('#tariffcreateBy').text(data.createBy || "N/A");
                $('#tariffcreateDate').text(data.createDate ? new Date(data.createDate).toLocaleString() : "N/A");
                $('#tariffeditBy').text(data.editBy || "N/A");
                $('#tariffeditDate').text(data.editDate ? new Date(data.editDate).toLocaleString() : "N/A");
                $('#tariffeditVersion').text(data.editVersion || 0.000);

                //checkTariffMandatoryFields(); // Validate required fields
            } catch (error) {
                console.error("Error populating modal fields:", error);
            }
        }

        function setTariffMode(mode) {
            try {
                const isView = mode === 'view';
                const canEdit = permissions.canEdit && !isView;

                // Enable/Disable tariff-related fields
                $('#tariff_cmb_task').data('kendoComboBox').enable(false);
                $('#tariff_cmb_chagre').data('kendoComboBox').enable(canEdit);
                $('#tariff_cmb_uom').data('kendoComboBox').enable(canEdit);
                $('#tariff_cmb_type').data('kendoComboBox').enable(canEdit);
                $('#tariff_cmb_fromplace').data('kendoComboBox').enable(canEdit);
                $('#tariff_cmb_toplace').data('kendoComboBox').enable(canEdit);

                // Enable/Disable numeric input fields
                $('#displayrate, #basicrate, #minunit, #maxunit').prop('readonly', !canEdit);

                // Enable/Disable additional charges fields based on isAdditional checkbox
                const isAdditionalChecked = $('#isAdditional').prop('checked');
                $('#additionalunit, #additionalrate').prop('readonly', !canEdit || !isAdditionalChecked);

                // Enable/Disable additional charges fields based on isAdditional checkbox
                const isPrepaymentChecked = $('#isprepayment').prop('checked');
                $('#prepaymentpercentage').prop('readonly', !canEdit || !isPrepaymentChecked);

                // Enable/Disable checkboxes
                $('#isAdditional, #isprepayment').prop('disabled', !canEdit);

                // Button visibility
                $('#btnTariffSave').toggle(canEdit);
                $('#btnTariffEdit').toggle(isView && permissions.canEdit);
                $('#btnTariffClose').show();
                $('#btnTariffClear').hide();
            } catch (error) {
                console.error("Error setting mode for Account Setup:", error);
            }
        }

        function deleteTariff(tariffId, taskId, customerId, portId, chargeId) {
            showDeleteModal("Are you sure you want to delete this record?", function () {
                $.ajax({
                    url: '@Url.Action("DeleteTariff", "Tariff", new { area = "Project" })',
                    type: "DELETE",
                    data: {
                        tariffId: tariffId,
                        companyId: companyId,
                        taskId: taskId,
                        customerId: customerId,
                        portId: portId,
                        chargeId: chargeId
                    },
                    success: function (response) {
                        if (response.success) {
                            // Reload the grid to reflect the deletion
                            loadTariffGrid();
                            $('#confirmationModal').modal('hide');
                            alert("The record has been successfully deleted.");
                        } else {

                            alert(response.message || "Failed to delete the record. Please try again.");
                        }
                    },
                    error: function () {

                        alert("An error occurred while attempting to delete the record. Please try again later.");
                    }
                });
            });
        }

        function saveTariff() {
            let customerId = getComboBoxValue('#cmb_customer', 0);
            let portId = getComboBoxValue('#cmb_port', 0);

            if (customerId == 0 || portId == 0) {
                alert("Please select both the customer and the port.");
            } else {
                let tariffData = {
                    TariffId: parseInt($('#tariffId').val()) || 0,
                    RateType: 'common',
                    TaskId: parseInt($('#tariff_cmb_task').val()) || 0,
                    ChargeId: parseInt($('#tariff_cmb_chagre').val()) || 0,
                    PortId: getComboBoxValue('#cmb_port', 0) || 0,
                    CustomerId: getComboBoxValue('#cmb_customer', 0) || 0,
                    CurrencyId: 1,
                    UomId: parseInt($('#tariff_cmb_uom').val()) || 0,
                    SlabUomId: parseInt($('#tariff_cmb_type').val()) || 0,
                    VisaTypeId: 0,
                    FromPlace: parseInt($('#tariff_cmb_fromplace').val()) || 0,
                    ToPlace: parseInt($('#tariff_cmb_toplace').val()) || 0,
                    DisplayRate: parseFloat($('#displayrate').val()) || 0,
                    BasicRate: parseFloat($('#basicrate').val()) || 0,
                    MinUnit: parseFloat($('#minunit').val()) || 0,
                    MaxUnit: parseFloat($('#maxunit').val()) || 0,
                    IsAdditional: $('#isAdditional').prop('checked'),
                    AdditionalUnit: parseFloat($('#additionalunit').val()) || 0,
                    AdditionalRate: parseFloat($('#additionalrate').val()) || 0,
                    PrepaymentPercentage: parseFloat($('#prepaymentpercentage').val()) || 0,
                    IsPrepayment: $('#isPrepayment').prop('checked'),
                    ItemNo: parseInt($('#itemNo').val()) || 0,
                    Remarks: $('#remarks').val()?.trim() || '',
                    IsActive: $('#isActive').prop('checked')
                };

                console.log("Tariff Data:", tariffData);

                // Validate mandatory fields
                if (!tariffData.RateType) {
                    alert('Rate Type, Task Name, and Charge Name are required!');
                    return;
                }

                // AJAX call to save the tariff
                $.ajax({
                    url: '@Url.Action("SaveTariff", "Tariff", new { area = "Project" })',
                    type: "POST",
                    data: JSON.stringify({ tariff: tariffData, companyId }), // Tariff data with companyId
                    contentType: "application/json",
                    success: function (response) {
                        if (response.success) {
                            // Reload the grid and reset the form on success
                            loadTariffGrid();
                            clearTariffForm();
                            $('#addTariffModal').modal('hide');
                            alert("Tariff saved successfully!");
                        } else {
                            // Show error message if the save was unsuccessful
                            alert(response.message || "Failed to save tariff. Please try again.");
                        }
                    },
                    error: function (xhr) {
                        // Handle server/network errors
                        alert("Error: " + (xhr.responseJSON?.message || "An unexpected error occurred. Please try again later."));
                    }
                });
            }
        }
    </script>
}