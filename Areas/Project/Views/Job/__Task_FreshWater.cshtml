<!-- FreshWater Modal -->
<div class="modal fade" id="addFreshWaterModal" tabindex="-1" aria-labelledby="addFreshWaterModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFreshWaterModalLabel">Fresh Water</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="freshWaterForm">
                    <input type="hidden" id="freshWater_jobOrderId" />
                    <input type="hidden" id="freshWaterId" />

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Fresh Water Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="launchServiceDate" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Charge Code</label>
                            <select class="form-select" id="chargeId">
                                <option value="">Select Charge</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">GL Account <span class="text-danger">*</span></label>
                            <select class="form-select" id="glId" required>
                                <option value="">Select GL</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Barge </label>
                            <select class="form-select" id="chargeId">
                                <option value="">Select Charge</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Supplier Barge</label>
                            <input type="text" class="form-control" id="quantity">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Barge Operator</label>
                            <input type="text" class="form-control" id="quantity">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Receipt No.</label>
                            <input type="text" class="form-control" id="quantity">
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Distance to Vessel</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="weightOfCargoLanded" step="0.0001"
                                        value="0.00">
                                    <span class="input-group-text">NM</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantity" step="0.01" value="0.00" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">UOM <span class="text-danger">*</span></label>
                            <select class="form-select" id="glId" required>
                                <option value="">Select UOM</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="statusId" required>
                                    <option value="">Select Status</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                        </div>
                        <div class="col-12">
                            <div class="mb-1">
                                <label class="form-label">Remark</label>
                                <textarea class="form-control" id="remark" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Fields -->
                    <div class="accordion mt-3" id="auditAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#auditCollapse">
                                    Audit Details
                                </button>
                            </h2>
                            <div id="auditCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Created By</label>
                                            <p id="freshwatercreateBy" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Created Date</label>
                                            <p id="freshwatercreateDate" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modified By</label>
                                            <p id="freshwatereditBy" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modified Date</label>
                                            <p id="freshwatereditDate" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Edit Version</label>
                                            <p id="freshwatereditVersion" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnBankFreshWaterClose"
                    onclick="clearBankFreshWaterForm()">Close</button>
                <button type="button" class="btn btn-primary" id="btnBankFreshWaterEdit">Edit</button>
                <button type="button" class="btn btn-secondary" id="btnBankFreshWaterClear"
                    onclick="clearBankFreshWaterForm()">Clear</button>
                <button type="button" class="btn btn-primary" id="btnBankFreshWaterSave"
                    onclick="saveBankFreshWater()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    function refreshFreshWaterDropdown() {
        const portUrl = '@Url.Action("GetPortLookup", "Lookup", new { area = "" })?companyId=' + companyId;
        bindComboBox(portUrl, "freshWater_cmb_port", "portName", "portId");

        const chartOfAccountUrl = '@Url.Action("GetChartOfAccountLookup", "Lookup", new { area = "" })?companyId=' + companyId;
        const glcolumnsProperties = [
            { field: 'glCode', title: 'Code', width: 100 },
            { field: 'glName', title: 'Name', width: 200 }
        ];
        const glfilterFields = ['glCode', 'glName'];
        bindMultiColumnComboBox(chartOfAccountUrl, "freshWater_cmb_gl", "glName", "glId");

        const chargeUrl = `@Url.Action("GetChargeLookup", "Lookup", new { area = "" })?companyId=${companyId}&taskId=3`;
        bindComboBox(chargeUrl, "freshWater_cmb_charge", "chargeName", "chargeId");

        const uomUrl = '@Url.Action("GetUomLookup", "Lookup", new { area = "" })?companyId=' + companyId;
        bindComboBox(uomUrl, "freshWater_cmb_uom", "uomName", "uomId");

        const statusUrl = `@Url.Action("GetOrderTypeLookup", "Lookup", new { area = "" })?companyId=${companyId}&categoryId=5`;
        bindComboBox(statusUrl, "freshWater_cmb_status", "orderTypeName", "orderTypeId");
    }

    function clearFreshWaterForm() {
        $('#freshWaterId').val('');
        $('#freshWater_jobOrderId').val('');
        $('#freshWater_jobOrderNo').val('');
        $('#freshWater_debitNoteId').val('');
        $('#freshWater_debitNoteNo').val('');

        $('#freshWater_cmb_gl').data('kendoMultiColumnComboBox').value('');
        $('#freshWater_cmb_charge').data('kendoComboBox').value('');
        $('#freshWater_cmb_uom').data('kendoComboBox').value('');
        $('#freshWater_cmb_status').data('kendoComboBox').value('');

        $('#freshWater_quantity').val('');
        $('#freshWater_deliverDate').val('');
        $('#isActive').prop('checked', true);
        $('#freshWater_remarks').val('');

        $('#freshWater_createBy').text('');
        $('#freshWater_createDate').text('');
        $('#freshWater_editBy').text('');
        $('#freshWater_editDate').text('');
        $('#freshWater_editVersion').text('');

        $('#btnFreshWaterClear').show();
    }

    function openFreshWaterModal(jobOrderId, jobOrderNo, freshWaterId, mode) {
        const $modal = $('#addFreshWaterModal');
        const parsedJobOrderId = parseInt(jobOrderId, 10);
        const parsedFreshWaterId = parseInt(freshWaterId, 10);
        $('#freshWater_jobOrderId').val(jobOrderId);
        $('#freshWater_jobOrderNo').val(jobOrderNo);

        const isValidId = id => !isNaN(id) && id !== null && id !== "" && id > 0;

        if (isValidId(parsedJobOrderId) && isValidId(parsedFreshWaterId)) {
            $modal.find('.modal-content').append('<div class="modal-overlay"><div class="spinner"></div></div>');

            $.get('@Url.Action("GetFreshWaterById", "Job", new { area = "Project" })', {
                jobOrderId: parsedJobOrderId,
                freshWaterId: parsedFreshWaterId,
                companyId: $('#companyId').val()
            })
                .done(function (response) {
                    if (response.success) {
                        refreshFreshWaterDropdown();
                        clearFreshWaterForm();
                        populateFreshWaterModalFields(response.data);
                        $('#addFreshWaterModal').modal('show');
                    }
                })
                .always(() => $modal.find('.modal-overlay').remove());
        } else {
            refreshFreshWaterDropdown();
            clearFreshWaterForm();
            setDefaultDropdownValues();
            $('#addFreshWaterModal').modal('show');
        }
    }

    function populateFreshWaterModalFields(data) {
        $('#companyId').val(data.companyId);
        $('#freshWaterId').val(data.freshWaterId);
        $('#freshWater_jobOrderId').val(data.jobOrderId);
        $('#freshWater_jobOrderNo').val(data.jobOrderNo);
        $('#freshWater_debitNoteId').val(data.debitNoteId);
        $('#freshWater_debitNoteNo').val(data.debitNoteNo);

        const chargeCombo = $('#freshWater_cmb_charge').data('kendoComboBox');
        chargeCombo.value(data.chargeId > 0 ? data.chargeId : '');
        chargeCombo.one('dataBound', function () {
            chargeCombo.value(data.chargeId > 0 ? data.chargeId : '');
        });

        const glCombo = $('#freshWater_cmb_gl').data('kendoMultiColumnComboBox');
        glCombo.value(data.glId > 0 ? data.glId : '');
        glCombo.one('dataBound', function () {
            glCombo.value(data.glId > 0 ? data.glId : '');
        });

        const uomCombo = $('#freshWater_cmb_uom').data('kendoComboBox');
        uomCombo.value(data.uomId > 0 ? data.uomId : '');
        uomCombo.one('dataBound', function () {
            uomCombo.value(data.uomId > 0 ? data.uomId : '');
        });

        const statusCombo = $('#freshWater_cmb_status').data('kendoComboBox');
        statusCombo.value(data.statusId > 0 ? data.statusId : '');
        statusCombo.one('dataBound', function () {
            statusCombo.value(data.statusId > 0 ? data.statusId : '');
        });

        $('#freshWater_quantity').val(data.quantity);
        const formattedDate = new Date(data.deliverDate).toLocaleDateString('en-CA');
        $('#freshWater_deliverDate').val(formattedDate);
        $('#isActive').prop('checked', data.isActive);
        $('#freshWater_remarks').val(data.remarks);

        $('#freshWater_createBy').text(data.createBy || "N/A");
        $('#freshWater_createDate').text(data.createDate ? new Date(data.createDate).toLocaleString() : "N/A");
        $('#freshWater_editBy').text(data.editBy || "N/A");
        $('#freshWater_editDate').text(data.editDate ? new Date(data.editDate).toLocaleString() : "N/A");
        $('#freshWater_editVersion').text(data.editVersion || "0");

        $('#btnFreshWaterClear').hide();
    }

    function saveFreshWater() {
        let freshWaterData = {
            FreshWaterId: parseInt($('#freshWaterId').val()) || 0,
            JobOrderId: parseInt($('#freshWater_jobOrderId').val()) || 0,
            JobOrderNo: $('#freshWater_jobOrderNo').val() || '',
            ChargeId: parseInt($('#freshWater_cmb_charge').data('kendoComboBox').value()) || 0,
            GLId: parseInt($('#freshWater_cmb_gl').data('kendoMultiColumnComboBox').value()) || 0,
            Quantity: parseFloat($('#freshWater_quantity').val()) || 0,
            UomId: parseInt($('#freshWater_cmb_uom').data('kendoComboBox').value()) || 0,
            DeliverDate: $('#freshWater_deliverDate').val() || '',
            StatusId: parseInt($('#freshWater_cmb_status').data('kendoComboBox').value()) || 0,
            Remarks: $('#freshWater_remarks').val(),
            IsActive: 1,
            DebitNoteId: parseInt($('#freshWater_debitNoteId').val()) || 0,
            DebitNoteNo: $('#freshWater_debitNoteNo').val() || '',
        };

        console.log("FreshWater Data : " + freshWaterData);

        $.ajax({
            url: '@Url.Action("SaveFreshWater", "Job", new { area = "Project" })',
            type: "POST",
            data: JSON.stringify({ freshWater: freshWaterData, companyId }),
            contentType: "application/json",
            success: function (response) {
                if (response.success) {
                    initializeFreshWaterGrid();
                    clearFreshWaterForm();
                    $('#addFreshWaterModal').modal('hide');
                } else {
                    alert(response.message || "Failed to save fresh water.");
                }
            },
            error: function (xhr) {
                alert("Error: " + (xhr.responseJSON?.message || "An unexpected error occurred"));
            }
        });
    }

    function deleteFreshWater(jobOrderId, freshWaterId) {
        showDeleteModal("Are you sure you want to delete this record?", function () {
            $.ajax({
                url: '@Url.Action("DeleteFreshWater", "Job", new { area = "Project" })',
                type: "DELETE",
                data: { jobOrderId, freshWaterId, companyId: companyId },
                success: function (response) {
                    if (response.success) {
                        loadFreshWaterGrid();
                        $('#confirmationModal').modal('hide');
                    }
                }
            });
        });
    }
</script>