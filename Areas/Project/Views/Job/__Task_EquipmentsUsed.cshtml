<!-- EquipmentUsed Modal -->
<div class="modal fade" id="addEquipmentUsedModal" tabindex="-1" aria-labelledby="addEquipmentUsedModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEquipmentUsedModalLabel">Equipments Used</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="equipmentUsedForm">
                    <input type="hidden" id="equipmentsused_jobOrderId" />
                    <input type="hidden" id="equipmentsusedId" />

                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Equipment Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="equipmentsused_launchServiceDate" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ref No <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="equipmentsused_refNo">
                        </div>
                        <div class="col-md-4">

                            <label class="form-label">Charge Code <span class="text-danger">*</span></label>
                            <select id="portExpense_cmb_gl" style="width: 100%"></select>
                        </div>
                        <div class="col-md-4">

                            <label class="form-label">GL Account <span class="text-danger">*</span></label>
                            <select id="portExpense_cmb_gl" style="width: 100%"></select>
                        </div>

                        <div class="col-md-4">

                            <label class="form-label">Mafi</label>
                            <input type="text" class="form-control" id="equipmentsused_mafi">
                        </div>

                        <div class="col-md-4">

                            <label class="form-label">Other</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>

                        <!-- Section 3: Charges & Equipment -->
                        <div class="col-md-4">

                            <label class="form-label">Crane Charge</label>
                            <select id="portExpense_cmb_creancharge" style="width: 100%"></select>
                        </div>
                        <div class="col-md-4">

                            <label class="form-label">Forklift Charge</label>
                            <select id="portExpense_cmb_forkliftcharge" style="width: 100%"></select>
                        </div>
                        <div class="col-md-4">

                            <label class="form-label">Stevedor Charge</label>
                            <select id="portExpense_cmb_stevedorcharge" style="width: 100%"></select>
                        </div>

                        <!--loading-->
                        <div class="col-md-3">

                            <label class="form-label">Loading Tally Sheet No</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Crane Loading (hr)</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">ForkLift Loading (hr)</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Stev. Loading (Nos)</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>

                        <!--Offloading-->
                        <div class="col-md-3">

                            <label class="form-label">Offloading Tally Sheet No</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>

                        <div class="col-md-3">

                            <label class="form-label">Crane OffLoading (hr)</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">ForkLift OffLoading (hr)</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Stev. OffLoading (Nos)</label>
                            <input type="text" class="form-control" id="equipmentsused_other">
                        </div>

                        <!-- Section 2: Time Tracking -->
                        <div class="col-md-3">

                            <label class="form-label">Morning Time In</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Morning Time Out</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Morning Total Hours</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Total Regular Hourss</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>

                        <div class="col-md-3">

                            <label class="form-label">Evening Time In</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Evening Time Out</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Evening Total Hours</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Total OverTime Hours</label>
                            <input type="time" class="form-control" id="equipmentsused_other">
                        </div>

                        <div class="col-md-3">

                            <label class="form-label">Driver Name</label>
                            <input type="text" class="form-control" id="driverName" value="Driver Name">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Vehicle Name</label>
                            <input type="text" class="form-control" id="vehicleName" value="Vehicle Name">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Order No</label>
                            <input type="text" class="form-control" value="Order Number">
                        </div>
                        <div class="col-md-3">

                            <label class="form-label">Lunch Service Debit Note</label>
                            <select id="portExpense_cmb_gl" style="width: 100%"></select>
                        </div>
                        <div class="col-md-3">
                            <label for="portExpense_cmb_status" class="form-label">Status  <span class="text-danger">*</span></label>
                            <select id="portExpense_cmb_status" style="width: 100%"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Remark</label>
                            <textarea class="form-control" id="portExpense_remarks" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="alert alert-info mt-3">
                                <small>Equipment Footer: Minimum 3 Hours, including mob-demob charges</small>
                            </div>
                        </div>

                        <!-- Existing maritime operation fields remain below -->
                        <!-- [Previous form sections for launch services, vessel timing, etc.] -->
                    </div>

                    <!-- Audit Fields -->
                    <div class="accordion mt-3" id="auditAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#auditCollapse">
                                    Audit Details
                                </button>
                            </h2>
                            <div id="auditCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Created By</label>
                                            <p id="portexpensecreateBy" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Created Date</label>
                                            <p id="portexpensecreateDate" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modified By</label>
                                            <p id="portexpenseeditBy" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modified Date</label>
                                            <p id="portexpenseeditDate" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Edit Version</label>
                                            <p id="portexpenseeditVersion" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnPortExpenseClear" onclick="clearPortExpenseForm()">Clear</button>
                <button type="button" class="btn btn-primary" id="btnPortExpenseSave" onclick="savePortExpense()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    function refreshEquipmentsUsedDropdown() {
         const chartOfAccountUrl = '@Url.Action("GetChartOfAccountLookup", "Lookup", new { area = "" })?companyId=' + companyId;
        const glcolumnsProperties = [
            { field: 'glCode', title: 'Code', width: 100 },
            { field: 'glName', title: 'Name', width: 200 }
        ];
        const glfilterFields = ['glCode', 'glName'];
        bindMultiColumnComboBox(chartOfAccountUrl, "equipmentsused_cmb_gl", "glName", "glId", glcolumnsProperties, glfilterFields);

        const chargeUrl = `@Url.Action("GetChargeLookup", "Lookup", new { area = "" })?companyId=${companyId}&taskId=1`;
        bindComboBox(chargeUrl, "equipmentsused_cmb_charge", "chargeName", "chargeId");

        const uomUrl = '@Url.Action("GetUomLookup", "Lookup", new { area = "" })?companyId=' + companyId;
        bindComboBox(uomUrl, "equipmentsused_cmb_uom", "uomName", "uomId");

        const statusUrl = `@Url.Action("GetOrderTypeLookup", "Lookup", new { area = "" })?companyId=${companyId}&categoryId=4`;
        bindComboBox(statusUrl, "equipmentsused_cmb_status", "orderTypeName", "orderTypeId");

    }

    function clearEquipmentsUsedForm() {
        $('#equipmentsused_jobOrderId').val('');
        $('#equipmentsusedId').val('');
        $('#equipmentsused_launchServiceDate').val('');
        $('#equipmentsused_chargeId').val('');
        $('#equipmentsused_glId').val('');
        $('#equipmentsused_mafi').val('');
        $('#equipmentsused_other').val('');
    }

    function openEquipmentsUsedModal(jobOrderId, jobOrderNo, equipmentsUsedId, mode) {

        const $modal = $('#addEquipmentsUsedModal');
        const parsedJobOrderId = parseInt(jobOrderId, 10);
        const parsedequipmentsUsedId = parseInt(equipmentsUsedId, 10);
        $('#equipmentsused_jobOrderId').val(jobOrderId);
        $('#equipmentsused_jobOrderNo').val(jobOrderNo);

        const isValidId = id => !isNaN(id) && id !== null && id !== "" && id > 0;

        // Edit Mode: Fetch existing data and populate the form
        if (isValidId(parsedJobOrderId) && isValidId(parsedequipmentsUsedId)) {

            $modal.find('.modal-content').append('<div class="modal-overlay"><div class="spinner"></div></div>');

            $.get('@Url.Action("GetEquipmentsUsedById", "Job", new { area = "Project" })', {
                jobOrderId: parsedJobOrderId,
                equipmentsUsedId: parsedequipmentsUsedId,
                companyId: $('#companyId').val()
            })
                .done(function (response) {
                    if (response.success) {
                        refreshEquipmentsUsedDropdown();
                        clearequipmentsusedForm();
                        populateequipmentsusedModalFields(response.data);
                        $('#addEquipmentsUsedModal').modal('show');
                    }
                })
                .always(() => $modal.find('.modal-overlay').remove());
        } else {
            // Add Mode: Clear form and set default values
            refreshEquipmentsUsedDropdown();
            clearequipmentsusedForm();
            setDefaultDropdownValues();

            $('#addEquipmentsUsedModal').modal('show');
        }
    }

    function saveEquipmentsUsed() {
        const equipmentsUsedData = {
            JobOrderId: parseInt($('#equipmentsused_jobOrderId').val()) || 0,
            EquipmentsUsedId: parseInt($('#equipmentsusedId').val()) || 0,
            LaunchServiceDate: $('#equipmentsused_launchServiceDate').val(),
            ChargeId: parseInt($('#equipmentsused_chargeId').val()) || 0,
            GLId: parseInt($('#equipmentsused_glId').val()) || 0,
            Mafi: $('#equipmentsused_mafi').val(),
            Other: $('#equipmentsused_other').val()
        };

        $.ajax({
            url: '@Url.Action("SaveEquipmentsUsed", "Job", new { area = "Project" })',
            type: 'POST',
            data: JSON.stringify(equipmentsUsedData),
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    alert('Equipments Used saved successfully!');
                    clearEquipmentsUsedForm();
                    $('#addEquipmentsUsedModal').modal('hide');
                } else {
                    alert(response.message || 'Failed to save equipments used.');
                }
            },
            error: function () {
                alert('An error occurred while saving the equipments used.');
            }
        });
    }

    function deleteEquipmentsUsed(jobOrderId, equipmentsUsedId) {
        showDeleteModal("Are you sure you want to delete this record?", function () {
            $.ajax({
                url: '@Url.Action("DeleteEquipmentsUsed", "Job", new { area = "Project" })',
                type: "DELETE",
                data: { jobOrderId, equipmentsUsedId, companyId: companyId },
                success: function (response) {
                    if (response.success) {
                        loadEquipmentsUsedGrid();
                        $('#confirmationModal').modal('hide');
                    }
                }
            });
        });
    }

    function populateEquipmentsUsedModalFields(data) {
        // Populate modal fields with data
        $('#companyId').val(data.companyId);
        $('#equipmentsUsedId').val(data.equipmentsUsedId);
        $('#equipmentsUsed_jobOrderId').val(data.jobOrderId);
        $('#equipmentsUsed_jobOrderNo').val(data.jobOrderNo);
        // ...existing code...
    }

    function openEquipmentsUsedModal(jobOrderId, jobOrderNo, equipmentsUsedId, mode) {
        const $modal = $('#addEquipmentsUsedModal');
        const parsedJobOrderId = parseInt(jobOrderId, 10);
        const parsedEquipmentsUsedId = parseInt(equipmentsUsedId, 10);
        $('#equipmentsUsed_jobOrderId').val(jobOrderId);
        $('#equipmentsUsed_jobOrderNo').val(jobOrderNo);

        if (parsedJobOrderId > 0 && parsedEquipmentsUsedId > 0) {
            $modal.find('.modal-content').append('<div class="modal-overlay"><div class="spinner"></div></div>');
            $.get('@Url.Action("GetEquipmentsUsedById", "Job", new { area = "Project" })', {
                jobOrderId: parsedJobOrderId,
                equipmentsUsedId: parsedEquipmentsUsedId,
                companyId: $('#companyId').val()
            })
                .done(function (response) {
                    if (response.success) {
                        refreshEquipmentsUsedDropdown();
                        clearEquipmentsUsedForm();
                        populateEquipmentsUsedModalFields(response.data);
                        $('#addEquipmentsUsedModal').modal('show');
                    }
                })
                .always(() => $modal.find('.modal-overlay').remove());
        } else {
            refreshEquipmentsUsedDropdown();
            clearEquipmentsUsedForm();
            setDefaultDropdownValues();
            $('#addEquipmentsUsedModal').modal('show');
        }
    }

    function setDefaultDropdownValues() {
        // Set default values for dropdowns
        $('#equipmentsUsed_cmb_gl').data('kendoMultiColumnComboBox').value(488);
        // ...existing code...
    }
</script>