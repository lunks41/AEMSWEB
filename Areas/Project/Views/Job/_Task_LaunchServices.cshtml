  <!-- LaunchService Modal -->
<div class="modal fade" id="addLaunchServiceModal" tabindex="-1" aria-labelledby="addLaunchServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLaunchServiceModalLabel">Launch Services</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="launchServiceForm">
                    <input type="hidden" id="launchService_jobOrderId" />
                    <input type="hidden" id="launchServiceId" />
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Launch Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="launchServiceDate" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Charge Code <span class="text-danger">*</span></label>
                                <select class="form-select" id="chargeId" required>
                                    <option value="">Select Charge</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Launch</label>
                                <select class="form-select" id="launchId" required>
                                    <option value="">Select Launch</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">UOM <span class="text-danger">*</span></label>
                                <select class="form-select" id="uomId" required>
                                    <option value="">Select Unit</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">GL Account <span class="text-danger">*</span></label>
                                <select class="form-select" id="glId" required>
                                    <option value="">Select GL</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Agent Tally</label>
                                <input type="text" class="form-control" id="agentTally">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Boat Oper Tally</label>
                                <input type="text" class="form-control" id="boatopTally">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Distance To Vessel</label>
                                <input type="number" class="form-control" id="distanceFromJettyToVessel" step="0.0001">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Lunch Hire Time (1)</label>
                                <input type="datetime-local" class="form-control" id="loadingTime">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Left Jetty (2)</label>
                                <input type="datetime-local" class="form-control" id="leftJetty">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Alongside Vessel (3)</label>
                                <input type="datetime-local" class="form-control" id="alongsideVessel">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Departed From Vessel (4)</label>
                                <input type="datetime-local" class="form-control" id="departedFromVessel">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-1">
                                <b>Waitg Time At Loadg Pt (2-1) : 01:00 Hrs</b>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <b>Waitg Time Along Side (4-3) :  01:00 Hrs</b>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Arrived At Jetty (5)</label>
                                <input type="datetime-local" class="form-control" id="arrivedAtJetty">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Weight Delivered</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="weightOfCargoDelivered" step="0.0001" value="0.00">
                                    <span class="input-group-text">Tons/Pallets</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Weight Landed</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="weightOfCargoLanded" step="0.0001" value="0.00">
                                    <span class="input-group-text">Tons/Pallets</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Boat Operator</label>
                                <input type="text" class="form-control" id="boatoperator">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Credit Inv No</label>
                                <input type="text" class="form-control" id="creditorsInvNo">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Annexure</label>
                                <input type="text" class="form-control" id="annexure">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Launch From (Port)</label>
                                <select class="form-select" id="lunchportId" required>
                                    <option value="">Select Port</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-1">
                                <label class="form-label">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="statusId" required>
                                    <option value="">Select Status</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-1">
                                <label class="form-label">Remark</label>
                                <textarea class="form-control" id="remark" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Fields -->
                    <div class="accordion mt-3" id="auditAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#auditCollapse">
                                    Audit Details
                                </button>
                            </h2>
                            <div id="auditCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Created By</label>
                                            <p id="freshwatercreateBy" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Created Date</label>
                                            <p id="freshwatercreateDate" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modified By</label>
                                            <p id="freshwatereditBy" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modified Date</label>
                                            <p id="freshwatereditDate" class="form-control-plaintext"></p>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Edit Version</label>
                                            <p id="freshwatereditVersion" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="col-12">
                    <div class="alert alert-info mt-3">
                        <p>Note:</p>
                        <ol>
                            <li>Launch Hire Time must and should be less than or equals to Left Jetty Time.</li>
                            <li>Left Jetty Time must and should be less than or equals to Along Side Vessel.</li>
                            <li>Along Side Vessel must and should be less than or equals to Departed From Vessel.</li>
                            <li>Departed From Vessel must and should be less than or equals to Back To Base.</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnBankLaunchServiceClose" onclick="clearBankLaunchServiceForm()">Close</button>
                <button type="button" class="btn btn-primary" id="btnBankLaunchServiceEdit">Edit</button>
                <button type="button" class="btn btn-secondary" id="btnBankLaunchServiceClear" onclick="clearBankLaunchServiceForm()">Clear</button>
                <button type="button" class="btn btn-primary" id="btnBankLaunchServiceSave" onclick="saveBankLaunchService()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Validation function
    function validateLaunchServiceForm() {
        let isValid = true;

        // Check required fields
        const requiredFields = [
            'launchServiceDate', 'chargeId', 'launchId', 'uomId', 'glId',
            'statusId', 'lunchportId'
        ];

        requiredFields.forEach(field => {
            const input = document.getElementById(field);
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        // Validate datetime sequence
        const times = [
            'loadingTime', 'leftJetty', 'alongsideVessel',
            'departedFromVessel', 'arrivedAtJetty'
        ].map(id => document.getElementById(id).value);

        for (let i = 0; i < times.length - 1; i++) {
            if (times[i] && times[i + 1] && new Date(times[i]) > new Date(times[i + 1])) {
                alert(`Time sequence error between ${times[i]} and ${times[i + 1]}`);
                isValid = false;
                break;
            }
        }

        return isValid;
    }

    // Save function
    function saveBankLaunchService() {
        if (!validateLaunchServiceForm()) return;

        const payload = {
            id: document.getElementById('launchServiceId').value || null,
            jobOrderId: document.getElementById('launchService_jobOrderId').value,
            launchDate: document.getElementById('launchServiceDate').value,
            chargeId: document.getElementById('chargeId').value,
            launchId: document.getElementById('launchId').value,
            uomId: document.getElementById('uomId').value,
            glId: document.getElementById('glId').value,
            agentTally: document.getElementById('agentTally').value,
            boatopTally: document.getElementById('boatopTally').value,
            distanceFromJettyToVessel: document.getElementById('distanceFromJettyToVessel').value,
            loadingTime: document.getElementById('loadingTime').value,
            leftJetty: document.getElementById('leftJetty').value,
            alongsideVessel: document.getElementById('alongsideVessel').value,
            departedFromVessel: document.getElementById('departedFromVessel').value,
            arrivedAtJetty: document.getElementById('arrivedAtJetty').value,
            weightOfCargoDelivered: document.getElementById('weightOfCargoDelivered').value,
            weightOfCargoLanded: document.getElementById('weightOfCargoLanded').value,
            boatoperator: document.getElementById('boatoperator').value,
            creditorsInvNo: document.getElementById('creditorsInvNo').value,
            annexure: document.getElementById('annexure').value,
            lunchportId: document.getElementById('lunchportId').value,
            statusId: document.getElementById('statusId').value,
            remark: document.getElementById('remark').value
        };

        const url = payload.id ? `/api/launch-services/${payload.id}` : '/api/launch-services';
        const method = payload.id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response error');
                return response.json();
            })
            .then(data => {
                clearBankLaunchServiceForm();
                alert('Saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('addLaunchServiceModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Save failed. Check console for details.');
            });
    }

    // Edit mode setup
    function editBankLaunchService(serviceData) {
        // Populate form fields
        Object.entries(serviceData).forEach(([key, value]) => {
            const element = document.getElementById(key);
            if (element) element.value = value;
        });

        // Set audit fields
        document.getElementById('freshwatercreateBy').textContent = serviceData.createdBy;
        document.getElementById('freshwatercreateDate').textContent = serviceData.createDate;
        document.getElementById('freshwatereditBy').textContent = serviceData.modifiedBy;
        document.getElementById('freshwatereditDate').textContent = serviceData.modifiedDate;
        document.getElementById('freshwatereditVersion').textContent = serviceData.version;

        // Show modal and set update mode
        document.getElementById('btnBankLaunchServiceSave').textContent = 'Update';
        new bootstrap.Modal(document.getElementById('addLaunchServiceModal')).show();
    }

    // Form reset function
    function clearBankLaunchServiceForm() {
        document.getElementById('launchServiceForm').reset();
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.getElementById('launchServiceId').value = '';
        document.getElementById('launchService_jobOrderId').value = '';
        document.getElementById('auditCollapse').classList.remove('show');
        document.getElementById('btnBankLaunchServiceSave').textContent = 'Save';
    }
</script>